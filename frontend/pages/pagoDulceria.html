<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago Dulcer√≠a</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="../styles/pagoDulceri.css">
</head>
<body>
    <div class="header-pago">
        <button class="volver-btn" id="volver-btn">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Atr√°s
        </button>
        <div class="titulo-header">Pago Dulcer√≠a</div>
        <div class="acciones-header">
            <div class="socio-display" id="socio-display">üë§</div>
            <button class="cerrar-btn" id="cerrar-btn" title="Cerrar">&times;</button>
        </div>
    </div>
    <div class="espacio-header"></div>
    <main id="main-content">
        <div class="asientos-layout">
            <div class="info-funcion-col">
                <div id="info-container" class="info-funcion-card"></div>
                <div id="info-total-container"></div>
            </div>
            <div class="asientos-col">
                <div class="progreso-pasos">
                    <div class="paso">
                        <span class="icono"><i class="fa-solid fa-burger"></i></span>
                        <span class="linea"></span>
                    </div>
                    <div class="paso activo">
                        <span class="icono"><i class="fa-regular fa-rectangle-list"></i></span>
                    </div>
                </div>
                <div id="pago-container">
                    <h2 style="text-align:center;font-size:2em;font-weight:900;color:#0d3c6e;margin-bottom:1.5em;">Elige una forma de Pago</h2>
                    <form id="form-pago" autocomplete="off" style="width:100%;">
                        <div class="input-linea" style="width:100%; margin-bottom:2.5em;">
                            <input type="text" id="nombre" name="nombre" required placeholder=" " />
                            <label for="nombre">Nombre completo</label>
                        </div>
                        <div class="input-linea" style="width:100%; margin-bottom:2.5em;">
                            <input type="email" id="correo" name="correo" required placeholder=" " />
                            <label for="correo">Correo electr√≥nico</label>
                        </div>
                        <div class="metodo-pago-opciones" style="width:100%; margin-bottom:2em;">
                            <details class="metodo-pago-card" id="card-tarjeta">
                                <summary>
                                    <input type="radio" class="metodo-radio" name="metodo-pago" id="radio-tarjeta" value="tarjeta" />
                                    <span class="metodo-titulo">Tarjeta de Cr√©dito o D√©bito</span>
                                    <span class="metodo-logos">
                                        <img src="../images/items/Visa.png" alt="Visa">
                                        <img src="../images/items/Amex.png" alt="Amex">
                                        <img src="../images/items/Mastercard.png" alt="Mastercard">
                                        <img src="../images/items/Interbank.png" alt="Interbank">
                                    </span>
                                </summary>
                                <div class="metodo-pago-formulario">
                                    <div class="form-group">
                                        <label for="numero-tarjeta">N√∫mero de la tarjeta</label>
                                        <input type="text" id="numero-tarjeta" name="numero-tarjeta" required>
                                    </div>
                                    <div class="row-flex form-group">
                                        <div class="col-flex">
                                            <label for="tipo-tarjeta">Tipo de Tarjeta</label>
                                            <select id="tipo-tarjeta" name="tipo-tarjeta" required>
                                                <option value="">Selecciona</option>
                                                <option value="credito">Cr√©dito</option>
                                                <option value="debito">D√©bito</option>
                                            </select>
                                        </div>
                                        <div class="col-flex">
                                            <label>Fecha de Vencimiento</label>
                                            <div style="display:flex; gap:10px;">
                                                <select id="mes" name="mes" required style="flex:1;">
                                                    <option value="">Mes</option>
                                                </select>
                                                <select id="anio" name="anio" required style="flex:1;">
                                                    <option value="">A√±o</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row-flex form-group">
                                        <div class="col-flex">
                                            <label for="cvv">CVV</label>
                                            <input type="text" id="cvv" name="cvv" required style="width:100%;">
                                        </div>
                                        <div class="col-flex"></div>
                                    </div>
                                    <div class="row-flex form-group">
                                        <div class="col-flex">
                                            <label for="tipo-doc-tarjeta">Tipo de documento</label>
                                            <select id="tipo-doc-tarjeta" name="tipo-doc-tarjeta" required>
                                                <option value="">Selecciona</option>
                                                <option value="dni">DNI</option>
                                                <option value="ce">CE</option>
                                            </select>
                                        </div>
                                        <div class="col-flex">
                                            <label for="num-doc-tarjeta">N√∫mero de documento</label>
                                            <input type="text" id="num-doc-tarjeta" name="num-doc-tarjeta" required>
                                        </div>
                                    </div>
                                    <div>
                                        <button type="submit" data-metodo="tarjeta">Pagar</button>
                                    </div>
                                </div>
                            </details>
                            <details class="metodo-pago-card" id="card-agora">
                                <summary>
                                    <input type="radio" class="metodo-radio" name="metodo-pago" id="radio-agora" value="agora" />
                                    <span class="metodo-titulo">App agora</span>
                                    <span class="metodo-logos">
                                        <img src="../images/items/agora.png" alt="Agora">
                                    </span>
                                </summary>
                                <div class="metodo-pago-formulario">
                                    <div class="form-group">
                                        <label for="celular-agora">N√∫mero de Celular</label>
                                        <input type="text" id="celular-agora" name="celular-agora" required>
                                    </div>
                                    <div class="row-flex form-group">
                                        <div class="col-flex">
                                            <label for="tipo-doc-agora">Tipo de documento</label>
                                            <select id="tipo-doc-agora" name="tipo-doc-agora" required>
                                                <option value="">Selecciona</option>
                                                <option value="dni">DNI</option>
                                                <option value="ce">CE</option>
                                            </select>
                                        </div>
                                        <div class="col-flex">
                                            <label for="num-doc-agora">N√∫mero de documento</label>
                                            <input type="text" id="num-doc-agora" name="num-doc-agora" required>
                                        </div>
                                    </div>
                                    <div>
                                        <button type="submit" data-metodo="agora">Pagar</button>
                                    </div>
                                </div>
                            </details>
                            <details class="metodo-pago-card" id="card-billetera">
                                <summary>
                                    <input type="radio" class="metodo-radio" name="metodo-pago" id="radio-billetera" value="billetera" />
                                    <span class="metodo-titulo">Billeteras Electr√≥nicas</span>
                                    <span class="metodo-logos">
                                        <img src="../images/items/Yape.png" alt="Yape">
                                        <img src="../images/items/Plin.png" alt="Plin">
                                        <img src="../images/items/Funki.png" alt="Tunki">
                                    </span>
                                </summary>
                                <div class="metodo-pago-formulario">
                                    <div class="row-flex form-group">
                                        <div class="col-flex">
                                            <label for="tipo-doc-billetera">Tipo de documento</label>
                                            <select id="tipo-doc-billetera" name="tipo-doc-billetera" required>
                                                <option value="">Selecciona</option>
                                                <option value="dni">DNI</option>
                                                <option value="ce">CE</option>
                                            </select>
                                        </div>
                                        <div class="col-flex">
                                            <label for="num-doc-billetera">N√∫mero de documento</label>
                                            <input type="text" id="num-doc-billetera" name="num-doc-billetera" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="celular-billetera">N√∫mero de Celular</label>
                                        <input type="text" id="celular-billetera" name="celular-billetera" required>
                                    </div>
                                    <div class="form-group">
                                        <label style="margin-bottom:12px;">Selecciona billetera:</label>
                                        <div style="display:flex; gap:20px; align-items:center;">
                                            <div style="display:flex;align-items:center;">
                                                <input type="radio" id="billetera-yape" name="billetera-tipo" value="yape" checked required style="width:auto; margin-right:8px;">
                                                <label for="billetera-yape" style="margin:0;">Yape</label>
                                            </div>
                                            <div style="display:flex;align-items:center;">
                                                <input type="radio" id="billetera-plin" name="billetera-tipo" value="plin" required style="width:auto; margin-right:8px;">
                                                <label for="billetera-plin" style="margin:0;">Plin</label>
                                            </div>
                                            <div style="display:flex;align-items:center;">
                                                <input type="radio" id="billetera-tunki" name="billetera-tipo" value="tunki" required style="width:auto; margin-right:8px;">
                                                <label for="billetera-tunki" style="margin:0;">Tunki</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <button type="submit" data-metodo="billetera">Pagar</button>
                                    </div>
                                </div>
                            </details>
                        </div>
                        <div class="checkbox-linea">
                            <input type="checkbox" id="acepto-terminos" name="acepto-terminos" required>
                            <label for="acepto-terminos">Acepto los <a href="#">T√©rminos y Condiciones</a>, <a href="#">Pol√≠tica de Privacidad</a>.</label>
                        </div>
                        <div class="checkbox-linea">
                            <input type="checkbox" id="acepto-tratamiento" name="acepto-tratamiento" required>
                            <label for="acepto-tratamiento">Acepto el <a href="#">Tratamiento Opcional de datos</a>.</label>
                        </div>
                        <div class="footer-legal">
                            * No se hacen cambios ni devoluciones<br>
                            * Toda la informaci√≥n de pago es segura<br>
                            * Algunas de las tarjetas de d√©bito con CVV podr√≠an ser rechazadas por la plataforma de pago que utilizamos debido a las pol√≠ticas de seguridad del banco
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
    <div id="resumen-modal-bg">
        <div class="resumen-modal" id="resumen-modal-content"></div>
    </div>
    <script type="module" src="../js/pagoDulceria.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetch('../../backend/auth/checkSession.php')
                .then(res => res.json())
                .then(data => {
                    const socioDisplay = document.getElementById('socio-display');
                    if (data.loggedIn && data.socio && data.socio.nombre) {
                        const nombre = data.socio.nombre;
                        const iniciales = nombre.split(' ').map(word => word[0]).join('').toUpperCase();
                        socioDisplay.textContent = iniciales;
                    } else {
                        socioDisplay.textContent = 'üë§';
                    }
                });
        });
        document.getElementById('volver-btn').onclick = function() {
            window.history.back();
        };
        document.getElementById('cerrar-btn').onclick = function() {
            const params = new URLSearchParams(window.location.search);
            const idCiudad = params.get('ciudad');
            const idCine = params.get('cine');
            if (idCiudad && idCine) {
                window.location.href = `dulceriaLading.html?ciudad=${idCiudad}&cine=${idCine}`;
            } else {
                window.location.href = 'dulceriaLading.html';
            }
        };
        document.addEventListener('DOMContentLoaded', () => {
            const detailsList = Array.from(document.querySelectorAll('.metodo-pago-card'));
            detailsList.forEach(details => {
                const radio = details.querySelector('.metodo-radio');
                details.addEventListener('toggle', function() {
                    if (details.open) {
                        detailsList.forEach(d => { if (d !== details) d.open = false; });
                        if (radio) radio.checked = true;
                    } else {
                        if (radio) radio.checked = false;
                    }
                });
                if (radio) {
                    radio.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (!details.open) details.open = true;
                    });
                }
            });
        });
        document.querySelectorAll('#pago-container details button[type="submit"]').forEach(btn => {
            btn.addEventListener('click', function(e) {
                const form = document.getElementById('form-pago');
                if (!form.checkValidity()) return;
                if (!form.acepto_terminos.checked) { alert('Debes aceptar los T√©rminos y Condiciones.'); e.preventDefault(); return; }
                if (!form.acepto_tratamiento.checked) { alert('Debes aceptar el Tratamiento Opcional de datos.'); e.preventDefault(); return; }
                const metodo = btn.getAttribute('data-metodo');
                if (metodo === 'tarjeta') {
                    if (!form['numero-tarjeta'].value.trim() || !form['tipo-tarjeta'].value || !form['mes'].value || !form['anio'].value || !form['cvv'].value.trim() || !form['tipo-doc-tarjeta'].value || !form['num-doc-tarjeta'].value.trim()) { alert('Completa todos los campos de tarjeta.'); e.preventDefault(); return; }
                }
                if (metodo === 'agora') {
                    if (!form['celular-agora'].value.trim() || !form['tipo-doc-agora'].value || !form['num-doc-agora'].value.trim()) { alert('Completa todos los campos de App agora.'); e.preventDefault(); return; }
                }
                if (metodo === 'billetera') {
                    if (!form['tipo-doc-billetera'].value || !form['num-doc-billetera'].value.trim() || !form['celular-billetera'].value.trim() || !form['billetera-tipo'].value) { alert('Completa todos los campos de billetera electr√≥nica.'); e.preventDefault(); return; }
                }
            });
        });
    </script>
</body>
</html>
