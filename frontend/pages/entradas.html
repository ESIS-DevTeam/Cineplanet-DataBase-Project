<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entradas</title>
    <style>
        body { font-family: sans-serif; }
        #info-container { margin: 2em auto; max-width: 800px; }
        #socio-display { position: absolute; top: 15px; right: 15px; font-size: 1.2em; border: 1px solid #ccc; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; user-select: none; }
        /* Estilos para el modal de login */
        #login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }
        #login-frame {
            width: 400px;
            height: 500px;
            border: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Entradas</h1>
        <div id="socio-display">üë§</div>
    </header>
    <div id="login-modal">
        <button id="close-login-modal" style="position:absolute;top:10px;right:10px;z-index:10000;">‚úñ</button>
        <iframe id="login-frame" src=""></iframe>
    </div>
    <main>
        <div id="info-container"></div>
        <div id="btns-container" style="text-align:center; margin:2em 0;">
            <button id="btn-volver" style="padding:0.7em 2em; font-size:1.1em; margin-right:1em; cursor:pointer;">Volver</button>
            <button id="btn-continuar" style="padding:0.7em 2em; font-size:1.1em; cursor:pointer;" disabled>Continuar</button>
        </div>
        <!-- ...contenido de entradas aqu√≠... -->
    </main>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(window.location.search);
        const esInvitado = params.get('invitado') === '1';

        // Verifica sesi√≥n antes de mostrar la p√°gina
        const sessionRes = await fetch('../../backend/auth/checkSession.php');
        const sessionData = await sessionRes.json();
        if (!sessionData.loggedIn && !esInvitado) {
            // Muestra el modal de login encima de la p√°gina actual
            const loginModal = document.getElementById('login-modal');
            const loginFrame = document.getElementById('login-frame');
            params.set('redirect', window.location.pathname + '?' + params.toString());
            params.set('fromEntradas', '1');
            loginFrame.src = `login.html?${params.toString()}`;
            loginModal.style.display = 'block';
            // Opcional: bloquear scroll y acciones en el fondo
            document.body.style.overflow = 'hidden';

            document.getElementById('close-login-modal').onclick = function() {
                document.getElementById('login-modal').style.display = 'none';
                document.body.style.overflow = '';
            };
            return;
        }

        const socioDisplay = document.getElementById('socio-display');
        if (sessionData.socio && sessionData.socio.nombre) {
            const nombre = sessionData.socio.nombre;
            const iniciales = nombre.split(' ').map(word => word[0]).join('').toUpperCase();
            socioDisplay.textContent = iniciales;
        } else {
            socioDisplay.textContent = 'üë§';
        }

        // Extrae par√°metros de la URL
        const idFuncion = params.get('funcion');
        const idPelicula = params.get('pelicula');

        if (!idFuncion) {
            document.getElementById('info-container').textContent = 'No se ha seleccionado funci√≥n.';
            return;
        }

        // Obtener datos completos de la funci√≥n y pel√≠cula
        let infoFuncion = null;
        try {
            const resInfo = await fetch(`http://localhost/Cineplanet-DataBase-Project/backend/api/getInfoFuncionCompleta.php?idFuncion=${idFuncion}`);
            infoFuncion = await resInfo.json();
        } catch {
            document.getElementById('info-container').textContent = 'Error al obtener la informaci√≥n de la funci√≥n.';
            return;
        }

        // Formatear fecha
        let fechaTexto = '';
        if (infoFuncion && infoFuncion.fecha) {
            const fechaObj = new Date(infoFuncion.fecha + 'T00:00:00');
            const hoy = new Date();
            hoy.setHours(0,0,0,0);
            if (fechaObj.getTime() === hoy.getTime()) {
                fechaTexto = `Hoy, ${fechaObj.getDate()} de ${fechaObj.toLocaleString('es-ES', { month: 'short' })} de ${fechaObj.getFullYear()}`;
            } else {
                const diasSemana = ['domingo','lunes','martes','mi√©rcoles','jueves','viernes','s√°bado'];
                fechaTexto = `${diasSemana[fechaObj.getDay()]}, ${fechaObj.getDate()} de ${fechaObj.toLocaleString('es-ES', { month: 'short' })} de ${fechaObj.getFullYear()}`;
            }
        }

        // Muestra la informaci√≥n igual que en asientos.js
        const infoDiv = document.createElement('div');
        infoDiv.innerHTML = `
            <div style="text-align:center;">
                ${infoFuncion.portada ? `<img src="${infoFuncion.portada}" alt="Portada" style="width:140px;height:140px;border-radius:50%;object-fit:cover;">` : ''}
            </div>
            <h2 style="font-weight:bold; margin:0.5em 0;">${infoFuncion.nombrePelicula || ''}</h2>
            <div style="margin-bottom:0.5em;">${infoFuncion.formato || ''}${infoFuncion.formato && infoFuncion.idioma ? ', ' : ''}${infoFuncion.idioma || ''}</div>
            <div style="font-weight:bold; margin-bottom:0.5em;">${infoFuncion.nombreCine || ''}</div>
            <div style="margin-bottom:0.3em;">
                <span>üìÖ ${fechaTexto}</span>
            </div>
            <div style="margin-bottom:0.3em;">
                <span>üïí ${infoFuncion.hora || ''}</span>
            </div>
            <div>
                <span>üè¢ ${infoFuncion.nombreSala || ''}</span>
            </div>
            <hr style="margin:1em 0;">
        `;
        document.getElementById('info-container').appendChild(infoDiv);

        // Botones
        const btnVolver = document.getElementById('btn-volver');
        const btnContinuar = document.getElementById('btn-continuar');

        btnVolver.addEventListener('click', () => {
            const params = new URLSearchParams(window.location.search);
            window.location.href = `asientos.html?${params.toString()}`;
        });

        // btnContinuar.disabled = false; // Habilita seg√∫n tu l√≥gica
        btnContinuar.addEventListener('click', () => {
            alert('Continuar con la compra...');
        });
    });
    </script>
</body>
</html>
