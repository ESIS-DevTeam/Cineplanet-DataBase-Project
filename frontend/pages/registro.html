<!DOCTYPE html>
<html lang="es">
<head>
    <title>Registro de Socio</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../styles/register.css">
</head>
<body>
    <div class="register-card">
        <button class="close-btn" onclick="window.history.back()" aria-label="Cerrar">&times;</button>
        <h2>Únete</h2>
        <p class="subtitle">Completa tus datos y accede a nuestro<br><span>universo de beneficios</span></p>
        
        <form method="POST" action="../../backend/auth/registro.php">
            <div class="form-grid">
                <div class="input-group">
                    <label>Tipo de documento</label>
                    <select name="tipoDocumento" required>
                        <option value="DNI">DNI</option>
                        <option value="CE">CE</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>N° de documento</label>
                    <input type="text" name="numeroDocumento" required>
                </div>

                <div class="input-group">
                    <label>Correo electrónico</label>
                    <input type="email" name="email" required>
                </div>
                <div class="input-group">
                    <label>Nombre</label>
                    <input type="text" name="nombre" required>
                </div>

                <div class="input-group">
                    <label>Apellido Paterno</label>
                    <input type="text" name="apellidoPaterno" required>
                </div>
                <div class="input-group">
                    <label>Apellido Materno</label>
                    <input type="text" name="apellidoMaterno" required>
                </div>

                <div class="input-group">
                    <label>Contraseña</label>
                    <input type="password" name="password" required>
                </div>
                <div class="input-group">
                    <label>Confirmar contraseña</label>
                    <input type="password" name="confirm_password" required>
                </div>

                <div class="input-group">
                    <label>Fecha de Nacimiento <small>(DD/MM/AAAA)</small></label>
                    <input type="date" name="fechaNacimiento" id="fechaNacimiento" required>
                </div>
                <div class="input-group">
                    <label>Número de Celular</label>
                    <input type="text" name="celular" required>
                </div>

                <div class="input-group">
                    <label>Departamento</label>
                    <select id="departamentoSelect" name="departamento" required>
                        <option value="">Seleccione departamento</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Provincia</label>
                    <select id="provinciaSelect" name="provincia" required disabled>
                        <option value="">Seleccione provincia</option>
                    </select>
                    <span id="provinciaLoading" class="loading-text" style="display:none;">Cargando provincias...</span>
                </div>

                <div class="input-group">
                    <label>Distrito</label>
                    <select id="distritoSelect" name="distrito" required disabled>
                        <option value="">Seleccione distrito</option>
                    </select>
                    <span id="distritoLoading" class="loading-text" style="display:none;">Cargando distritos...</span>
                </div>
                <div class="input-group">
                    <label>Tu Cineplanet favorito <small>Campo Opcional</small></label>
                    <select id="cineplanetFavoritoSelect" name="cineplanetFavorito" required>
                        <option value="">Seleccione un cine</option>
                    </select>
                </div>
            </div>

            <div class="gender-section">
                <span class="gender-label">Género</span>
                <div class="gender-options">
                    <label><input type="radio" name="genero" value="Hombre" required> Hombre</label>
                    <label><input type="radio" name="genero" value="Mujer" required> Mujer</label>
                </div>
            </div>

            <div class="checkbox-section">
                <div class="checkbox-item">
                    <input type="checkbox" name="acepta_terminos" required>
                    <span>Acepto los <a href="#">Términos y Condiciones</a> y la <a href="#">Política de Privacidad</a></span>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" name="acepta_finalidades" required>
                    <span>He leído y acepto las finalidades de tratamiento adicionales</span>
                </div>
            </div>

            <button type="submit" class="submit-btn"><i class="fa-regular fa-user"></i> Unirme</button>
        </form>
    </div>

    <script>
        const departamentoSelect = document.getElementById('departamentoSelect');
        const provinciaSelect = document.getElementById('provinciaSelect');
        const provinciaLoading = document.getElementById('provinciaLoading');
        const distritoSelect = document.getElementById('distritoSelect');
        const distritoLoading = document.getElementById('distritoLoading');

        let departamentos = [];
        let provincias = [];
        let distritos = [];

        // Cargar departamentos
        async function cargarDepartamentos() {
          try {
            const respuesta = await fetch('https://raw.githubusercontent.com/joseluisq/ubigeos-peru/master/json/departamentos.json');
            const data = await respuesta.json();
            departamentos = Object.values(data);

            departamentos.forEach(dep => {
              const option = document.createElement('option');
              option.value = dep.id_ubigeo;
              option.textContent = dep.nombre_ubigeo;
              departamentoSelect.appendChild(option);
            });
          } catch (error) {
            console.error("Error al cargar departamentos:", error);
          }
        }

        // Cargar TODAS las provincias
        async function cargarProvincias() {
          try {
            const respuesta = await fetch('https://raw.githubusercontent.com/joseluisq/ubigeos-peru/master/json/provincias.json');
            const data = await respuesta.json();
            // Convierte cualquier estructura en un solo array plano
            if (Array.isArray(data)) {
              provincias = data.flat(Infinity);
            } else if (Array.isArray(data.provincias)) {
              provincias = data.provincias.flat(Infinity);
            } else if (typeof data === 'object') {
              provincias = Object.values(data).flat(Infinity);
            } else {
              provincias = [];
            }
            console.log("Array de provincias plano:", provincias);
          } catch (error) {
            console.error("Error al cargar provincias:", error);
          }
        }

        // Cargar TODOS los distritos
        async function cargarDistritos() {
          try {
            const respuesta = await fetch('https://raw.githubusercontent.com/joseluisq/ubigeos-peru/master/json/distritos.json');
            const data = await respuesta.json();
            // Convierte cualquier estructura en un solo array plano
            if (Array.isArray(data)) {
              distritos = data.flat(Infinity);
            } else if (Array.isArray(data.distritos)) {
              distritos = data.distritos.flat(Infinity);
            } else if (typeof data === 'object') {
              distritos = Object.values(data).flat(Infinity);
            } else {
              distritos = [];
            }
            console.log("Array de distritos plano:", distritos);
          } catch (error) {
            console.error("Error al cargar distritos:", error);
          }
        }

        // Cargar cines desde el endpoint API
        async function cargarCines() {
          try {
            const respuesta = await fetch('../../backend/api/getCines.php');
            const data = await respuesta.json();
            const cineSelect = document.getElementById('cineplanetFavoritoSelect');
            cineSelect.innerHTML = '<option value="">Seleccione un cine</option>';
            data.forEach(cine => {
              // Soporta tanto objetos como arrays asociativos
              const id = cine.id ?? cine['id'];
              const nombre = cine.nombre ?? cine['nombre'];
              const option = document.createElement('option');
              option.value = id;
              option.textContent = nombre;
              cineSelect.appendChild(option);
            });
          } catch (error) {
            console.error("Error al cargar cines:", error);
          }
        }

        // Evento: cuando cambia el departamento
        departamentoSelect.addEventListener('change', function () {
          provinciaSelect.innerHTML = '<option value="">Seleccione provincia</option>';
          provinciaSelect.disabled = true;
          provinciaLoading.style.display = 'inline';

          const idDepartamento = String(this.value).trim();

          // Imprime solo los id_padre_ubigeo de todas las provincias
          provincias.forEach(p => {
            console.log(p.id_padre_ubigeo);
          });

          // Filtrar provincias que pertenezcan a este departamento
          const provinciasFiltradas = provincias.filter(
            p => typeof p.id_padre_ubigeo !== "undefined" &&
                 String(p.id_padre_ubigeo).trim() === idDepartamento
          );

          // Debug: muestra el resultado del filtro
          console.log("ID departamento seleccionado:", idDepartamento);
          console.log("Provincias filtradas:", provinciasFiltradas);

          if (provinciasFiltradas.length > 0) {
            provinciasFiltradas.forEach(prov => {
              const option = document.createElement('option');
              option.value = prov.id_ubigeo;
              option.textContent = prov.nombre_ubigeo;
              provinciaSelect.appendChild(option);
            });
            provinciaSelect.disabled = false;
          } else {
            provinciaSelect.innerHTML = '<option value="">No hay provincias</option>';
          }
          provinciaLoading.style.display = 'none';
        });

        // Evento: cuando cambia la provincia
        provinciaSelect.addEventListener('change', function () {
          distritoSelect.innerHTML = '<option value="">Seleccione distrito</option>';
          distritoSelect.disabled = true;
          distritoLoading.style.display = 'inline';

          const idProvincia = String(this.value).trim();

          // Filtrar distritos que pertenezcan a esta provincia
          const distritosFiltrados = distritos.filter(
            d => typeof d.id_padre_ubigeo !== "undefined" &&
                 String(d.id_padre_ubigeo).trim() === idProvincia
          );

          console.log("ID provincia seleccionada:", idProvincia);
          console.log("Distritos filtrados:", distritosFiltrados);

          if (distritosFiltrados.length > 0) {
            distritosFiltrados.forEach(dist => {
              const option = document.createElement('option');
              option.value = dist.id_ubigeo;
              option.textContent = dist.nombre_ubigeo;
              distritoSelect.appendChild(option);
            });
            distritoSelect.disabled = false;
          } else {
            distritoSelect.innerHTML = '<option value="">No hay distritos</option>';
          }
          distritoLoading.style.display = 'none';
        });

        // Limita la fecha de nacimiento para mayores de 18 años
        document.addEventListener('DOMContentLoaded', function () {
            const fechaInput = document.getElementById('fechaNacimiento');
            if (fechaInput) {
                const hoy = new Date();
                hoy.setFullYear(hoy.getFullYear() - 18);
                const maxFecha = hoy.toISOString().split('T')[0];
                fechaInput.max = maxFecha;
            }
        });

        // Inicializar
        cargarDepartamentos();
        cargarProvincias();
        cargarDistritos();
        cargarCines();
    </script>
    <script src="../js/registro.js"></script>
</body>
</html>
