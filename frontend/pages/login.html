<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Socio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../styles/login.css">
    <script>
    // Obtiene el parámetro redirect de la URL
    function getRedirect() {
        const params = new URLSearchParams(window.location.search);
        return params.get('redirect') || 'index.html';
    }

    function enviarLogin(event) {
        event.preventDefault();
        const form = event.target;
        const datos = new FormData(form);

        fetch('../../backend/auth/login.php', {
            method: 'POST',
            body: datos
        })
        .then(res => res.json())
        .then(data => {
            console.log('Login response:', data); // <-- Depuración
            if (data.success) {
                // Redirección según tipo de usuario
                if (data.socio && data.socio.tipo === 'admin') {
                    window.location.replace('admin/adminPanel.html');
                    return;
                }
                // Si está en iframe/modal, recarga la página principal y cierra el modal
                if (window.parent && window.parent !== window) {
                    window.parent.location.reload();
                } else {
                    window.location.href = getRedirect();
                }
            } else {
                alert(data.message || 'Error de login');
            }
        })
        .catch(() => alert('Error de conexion'));
    }

    function mostrarBotonInvitado() {
        const params = new URLSearchParams(window.location.search);
        // Ocultar boton X si venimos de entradas (caso no general)
        if (params.get('fromEntradas') === '1') {
            const closeBtn = document.querySelector('.close-btn');
            if (closeBtn) closeBtn.style.display = 'none';

            const btn = document.createElement('button');
            btn.textContent = 'Seguir como invitado';
            btn.style.marginTop = '1em';
            btn.onclick = function() {
                // Redirige a entradas.html con los parámetros originales + invitado=1
                let redirect = params.get('redirect') || 'entradas.html';
                if (!redirect.includes('invitado=1')) {
                    if (redirect.includes('?')) {
                        redirect += '&invitado=1';
                    } else {
                        redirect += '?invitado=1';
                    }
                }
                // Si está en iframe/modal, navega la ventana principal y reemplaza el historial
                if (window.parent && window.parent !== window) {
                    window.parent.location.replace(redirect);
                } else {
                    window.location.replace(redirect);
                }
            };
            document.getElementById('invitado-container').appendChild(btn);
        }
    }
    document.addEventListener('DOMContentLoaded', mostrarBotonInvitado);
    </script>
</head>
<body>
    <div class="login-card">
        <button class="close-btn" onclick="window.history.back()" aria-label="Cerrar">&times;</button>
        <h2>Iniciar sesión</h2>
        <p class="description">Ingresa a tu cuenta para disfrutar de tus beneficios, acumular puntos y vivir al máximo la experiencia Cineplanet.</p>
        
        <form method="POST" action="../../backend/auth/login.php" onsubmit="enviarLogin(event)">
            <div class="form-group">
                <label>N° de Socio Cineplanet</label>
                <input type="text" name="numeroDocumento" required>
                <div class="helper-text">DNI, RUT, CE o Pasaporte.</div>
            </div>
            
            <div class="form-group">
                <label>Contraseña</label>
                <div class="password-container">
                    <input type="password" name="password" required>
                    <i class="fa-solid fa-circle-question help-icon" title="Ayuda"></i>
                </div>
            </div>
            
            <a href="#" class="forgot-password">¿Olvidaste tu contraseña?</a>
            
            <button type="submit">Ingresar</button>
        </form>
        <div id="invitado-container"></div>
    </div>
</body>
</html>