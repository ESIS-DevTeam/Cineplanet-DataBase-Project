<!DOCTYPE html>
<html>
<head>
    <title>Login Socio</title>
    <script>
    // Obtiene el parámetro redirect de la URL
    function getRedirect() {
        const params = new URLSearchParams(window.location.search);
        return params.get('redirect') || 'index.html';
    }

    function enviarLogin(event) {
        event.preventDefault();
        const form = event.target;
        const datos = new FormData(form);

        fetch('../../backend/auth/login.php', {
            method: 'POST',
            body: datos
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // Si está en iframe/modal, recarga la página principal y cierra el modal
                if (window.parent && window.parent !== window) {
                    window.parent.location.reload();
                } else {
                    window.location.href = getRedirect();
                }
            } else {
                alert(data.message || 'Error de login');
            }
        })
        .catch(() => alert('Error de conexion'));
    }

    function mostrarBotonInvitado() {
        const params = new URLSearchParams(window.location.search);
        if (params.get('fromEntradas') === '1') {
            const btn = document.createElement('button');
            btn.textContent = 'Seguir como invitado';
            btn.style.marginTop = '1em';
            btn.onclick = function() {
                // Redirige a entradas.html con los parámetros originales + invitado=1
                let redirect = params.get('redirect') || 'entradas.html';
                if (!redirect.includes('invitado=1')) {
                    if (redirect.includes('?')) {
                        redirect += '&invitado=1';
                    } else {
                        redirect += '?invitado=1';
                    }
                }
                // Si está en iframe/modal, navega la ventana principal y reemplaza el historial
                if (window.parent && window.parent !== window) {
                    window.parent.location.replace(redirect);
                } else {
                    window.location.replace(redirect);
                }
            };
            document.getElementById('invitado-container').appendChild(btn);
        }
    }
    document.addEventListener('DOMContentLoaded', mostrarBotonInvitado);
    </script>
</head>
<body>
    <h2>Iniciar sesion como socio</h2>
    <form method="POST" action="../../backend/auth/login.php" onsubmit="enviarLogin(event)">
        <label>Numero de documento (DNI):</label>
        <input type="text" name="numeroDocumento" required><br>
        <label>Contrasenia:</label>
        <input type="password" name="password" required><br>
        <button type="submit">Ingresar</button>
    </form>
    <div id="invitado-container"></div>
</body>
</html>