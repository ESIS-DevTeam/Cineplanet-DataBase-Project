<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dulcer√≠a</title>
    <style>
        body { font-family: sans-serif; }
        #info-container { margin: 2em auto; max-width: 800px; }
        #socio-display { position: absolute; top: 15px; right: 15px; font-size: 1.2em; border: 1px solid #ccc; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; user-select: none; }
    </style>
</head>
<body>
    <header id="main-header">
        <h1>Dulcer√≠a</h1>
        <div id="socio-display">üë§</div>
    </header>
    <main id="main-content">
        <div id="info-container"></div>
        <!-- Aqu√≠ ir√° el contenido de dulcer√≠a -->
    </main>
    <script type="module">
    import BASE_API_DOMAIN from "../js/config.js";
    document.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(window.location.search);
        const idFuncion = params.get('funcion');
        const idPelicula = params.get('pelicula');
        const asientos = params.get('asientos') ? params.get('asientos').split(',').filter(x => x) : [];
        // Parsear promociones seleccionadas
        // promos=1:2,3:1 => [{id:'1',cantidad:2},{id:'3',cantidad:1}]
        let promosSeleccionadas = [];
        if (params.get('promos')) {
            promosSeleccionadas = params.get('promos').split(',').map(p => {
                const [id, cantidad] = p.split(':');
                return { id, cantidad: parseInt(cantidad, 10) };
            });
        }
        // Mostrar socio
        fetch('../../backend/auth/checkSession.php')
            .then(res => res.json())
            .then(data => {
                const socioDisplay = document.getElementById('socio-display');
                if (data.loggedIn && data.socio && data.socio.nombre) {
                    const nombre = data.socio.nombre;
                    const iniciales = nombre.split(' ').map(word => word[0]).join('').toUpperCase();
                    socioDisplay.textContent = iniciales;
                } else {
                    socioDisplay.textContent = 'üë§';
                }
            });
        if (!idFuncion) {
            document.getElementById('info-container').textContent = 'No se ha seleccionado funci√≥n.';
            return;
        }
        let infoFuncion = null;
        try {
            const resInfo = await fetch(BASE_API_DOMAIN + `getInfoFuncionCompleta.php?idFuncion=${idFuncion}`);
            infoFuncion = await resInfo.json();
        } catch {
            document.getElementById('info-container').textContent = 'Error al obtener la informaci√≥n de la funci√≥n.';
            return;
        }
        let fechaTexto = '';
        if (infoFuncion && infoFuncion.fecha) {
            const fechaObj = new Date(infoFuncion.fecha + 'T00:00:00');
            const hoy = new Date();
            hoy.setHours(0,0,0,0);
            if (fechaObj.getTime() === hoy.getTime()) {
                fechaTexto = `Hoy, ${fechaObj.getDate()} de ${fechaObj.toLocaleString('es-ES', { month: 'short' })} de ${fechaObj.getFullYear()}`;
            } else {
                const diasSemana = ['domingo','lunes','martes','mi√©rcoles','jueves','viernes','s√°bado'];
                fechaTexto = `${diasSemana[fechaObj.getDay()]}, ${fechaObj.getDate()} de ${fechaObj.toLocaleString('es-ES', { month: 'short' })} de ${fechaObj.getFullYear()}`;
            }
        }
        const infoDiv = document.createElement('div');
        infoDiv.innerHTML = `
            <div style="text-align:center;">
                ${infoFuncion.portada ? `<img src="${infoFuncion.portada}" alt="Portada" style="width:140px;height:140px;border-radius:50%;object-fit:cover;">` : ''}
            </div>
            <h2 style="font-weight:bold; margin:0.5em 0;">${infoFuncion.nombrePelicula || ''}</h2>
            <div style="margin-bottom:0.5em;">${infoFuncion.formato || ''}${infoFuncion.formato && infoFuncion.idioma ? ', ' : ''}${infoFuncion.idioma || ''}</div>
            <div style="font-weight:bold; margin-bottom:0.5em;">${infoFuncion.nombreCine || ''}</div>
            <div style="margin-bottom:0.3em;">
                <span>üìÖ ${fechaTexto}</span>
            </div>
            <div style="margin-bottom:0.3em;">
                <span>üïí ${infoFuncion.hora || ''}</span>
            </div>
            <div>
                <span>üè¢ ${infoFuncion.nombreSala || ''}</span>
            </div>
            <hr style="margin:1em 0;">
        `;
        document.getElementById('info-container').appendChild(infoDiv);
        // Puedes usar los datos as√≠:
        // idFuncion, idPelicula, asientos (array), promosSeleccionadas (array de objetos {id, cantidad})
        // Ejemplo de visualizaci√≥n r√°pida:
        const infoContainer = document.getElementById('info-container');
        const resumenDiv = document.createElement('div');
        resumenDiv.innerHTML = `
            <h3>Resumen de selecci√≥n</h3>
            <div><strong>Asientos:</strong> ${asientos.join(', ') || 'No seleccionados'}</div>
            <div><strong>Promociones:</strong> ${
                promosSeleccionadas.length
                    ? promosSeleccionadas.map(p => `Promo ${p.id} x${p.cantidad}`).join(', ')
                    : 'Ninguna'
            }</div>
        `;
        infoContainer.appendChild(resumenDiv);

        // ...aqu√≠ va el resto de dulcer√≠a...
    });
    </script>
</body>
</html>
