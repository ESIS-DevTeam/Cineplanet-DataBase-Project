<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dulcer칤a</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="../styles/dulceria.css">
    <style>
        /* Estilos para el modal de login */
        #login-modal {
            background: #fff !important;
            box-shadow: none !important;
            border: none !important;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 9999;
            display: none;
            width: 100vw;
            height: 100vh;
        }
        #login-modal iframe {
            border: none;
            box-shadow: none;
            background: transparent;
            width: 100vw;
            height: 100vh;
        }
        /* Opcional: ocultar scroll del body cuando el modal est치 activo */
        body[style*="overflow: hidden"] {
            background: #fff !important;
        }
    </style>
</head>
<body>
    <div class="header-dulceria">
        <button class="volver-btn" id="volver-btn-dulceria">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Atr치s
        </button>
        <div class="titulo-header">3. Dulcer칤a</div>
        <div class="acciones-header">
            <div class="socio-display" id="socio-display-dulceria">游녻</div>
            <button class="cerrar-btn" id="cerrar-btn-dulceria" title="Cerrar">
                &times;
            </button>
        </div>
    </div>
    <div class="espacio-header-dulceria"></div>
    <main id="main-content">
        <div class="dulceria-layout">
            <div class="info-funcion-dulceria-col">
                <div id="info-funcion-dulceria"></div>
            </div>
            <div class="dulceria-col">
                <!-- Barra de progreso de pasos (igual que asientos.html) -->
                <div class="progreso-pasos">
                    <div class="paso">
                        <span class="icono"><i class="fa-solid fa-chair"></i></span>
                        <span class="linea"></span>
                    </div>
                    <div class="paso">
                        <span class="icono"><i class="fa-solid fa-ticket"></i></span>
                        <span class="linea"></span>
                    </div>
                    <div class="paso activo">
                        <span class="icono"><i class="fa-solid fa-burger"></i></span>
                        <span class="linea"></span>
                    </div>
                    <div class="paso">
                        <span class="icono"><i class="fa-regular fa-rectangle-list"></i></span>
                    </div>
                </div>
                <div id="info-container"></div>
                <!-- Aqu칤 ir치 el contenido de dulcer칤a -->
            </div>
        </div>
    </main>
    <!-- Modal login solo con iframe -->
    <div id="login-modal">
        <iframe id="login-frame"></iframe>
    </div>
    <script type="module">
    // Verifica si lleg칩 desde dulceriaLading.html
    const params = new URLSearchParams(window.location.search);
    const fromLanding = document.referrer.includes('dulceriaLading.html') || params.has('ciudad') || params.has('cine');
    const esInvitado = params.get('invitado') === '1';

    // Chequea sesi칩n
    fetch('../../backend/auth/checkSession.php')
        .then(res => res.json())
        .then (data => {
            if (!data.loggedIn && fromLanding && !esInvitado) {
                document.getElementById('main-content').classList.add('oculto-por-modal');
                // Solo agrega la clase si existe el elemento
                const mainHeader = document.getElementById('main-header');
                if (mainHeader) mainHeader.classList.add('oculto-por-modal');
                const loginModal = document.getElementById('login-modal');
                const loginFrame = document.getElementById('login-frame');
                params.set('redirect', window.location.pathname + '?' + params.toString());
                params.set('fromEntradas', '1'); // <-- Agrega este par치metro
                loginFrame.src = `login.html?${params.toString()}`;
                loginModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            } else {
                // Si est치 logueado o es invitado, asegura que el contenido est칠 visible
                document.getElementById('main-content').classList.remove('oculto-por-modal');
                const mainHeader = document.getElementById('main-header');
                if (mainHeader) mainHeader.classList.remove('oculto-por-modal');
                document.getElementById('login-modal').style.display = 'none';
                document.body.style.overflow = '';
            }
        });

    // Header Dulcer칤a: usuario y botones
    document.addEventListener('DOMContentLoaded', () => {
        fetch('../../backend/auth/checkSession.php')
            .then(res => res.json())
            .then(data => {
                const socioDisplay = document.getElementById('socio-display-dulceria');
                if (data.loggedIn && data.socio && data.socio.nombre) {
                    const nombre = data.socio.nombre;
                    const iniciales = nombre.split(' ').map(word => word[0]).join('').toUpperCase();
                    socioDisplay.textContent = iniciales;
                } else {
                    socioDisplay.textContent = '游녻';
                }
            });
        // Bot칩n volver
        document.getElementById('volver-btn-dulceria').onclick = function() {
            const params = new URLSearchParams(window.location.search);
            // MODIFICADO: Si viene de dulceriaLading, regresa ah칤
            if (document.referrer.includes('dulceriaLading.html') || params.has('ciudad') || params.has('cine')) {
                const ciudad = params.get('ciudad');
                const cine = params.get('cine');
                let url = 'dulceriaLading.html';
                if (ciudad && cine) {
                    url += `?ciudad=${ciudad}&cine=${cine}`;
                }
                window.location.href = url;
                return;
            }
            const idPelicula = params.get('pelicula');
            const idFuncion = params.get('funcion');
            const asientos = params.get('asientos');
            let url = 'entradas.html';
            if (idPelicula && idFuncion) {
                url += `?pelicula=${idPelicula}&funcion=${idFuncion}`;
                if (asientos) url += `&asientos=${asientos}`;
                if (params.get('invitado') === '1') url += '&invitado=1';
            }
            window.location.href = url;
        };
        // Bot칩n cerrar (X)
        document.getElementById('cerrar-btn-dulceria').onclick = function() {
            const params = new URLSearchParams(window.location.search);
            const idPelicula = params.get('pelicula');
            if (idPelicula) {
                window.location.href = `peliculaSeleccion.html?pelicula=${idPelicula}`;
            } else {
                window.location.href = 'peliculaSeleccion.html';
            }
        };
    });
    </script>
    <script type="module" src="../js/dulceria.js"></script>
</body>
</html>
